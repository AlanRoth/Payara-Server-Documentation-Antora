[[notification-service]]
= Notification Service

Payara Server comes with a general Notification service in order to log events which come from other services, such as the
xref:/documentation/payara-server/jmx-monitoring-service/jmx-monitoring-service.adoc[JMX Monitoring Service], the xref:/documentation/payara-server/health-check-service/Overview.adoc[HealthCheck service] or the
xref:/documentation/payara-server/request-tracing-service/request-tracing-service.adoc[Request Tracing service].

The Notification service provides the ability to disseminate
notification events through various channels that are being created by
other services. This service is provided with a number of configurable
_notifiers_, the default being the Log Notifier.

[[log-notifier]]
== Log Notifier

The log notifier is the only notifier that is enabled by default when
the notification service is activated.

The default output for the log notifier is the configured instance log
file, which is either the _server.log_ file or _cluster.log_ file, depending
on the instance configuration.

The log notifier only handles the output of notifications from the
notification service sent to the log and is not responsible for any
other log output - more details on Payara Server logging can be found on
xref:/documentation/payara-server/logging/logging.adoc[the logging page].

[[configuration]]
=== Configuration

By default, the log notifier will receive notifications from the notification
service and output them to the configured logs when activated.

[[payara-configuration]]
==== Payara Configuration

Because the log notifier is the default notifier for the notification service
it can be configured on the same page as the notification service, as shown in
the image below:

image:notification-service/log/log-notifier.png[4.1.2.172 log-notifier]

For any new domain, the notification service will be disabled by default. It
can be enabled through the admin console as shown above, or via asadmin commands.

To configure the log notifier through the asadmin tool, use the
`set-log-notifier-configuration` subcommand:

[source, shell]
----
NAME
     set-log-notifier-configuration

SYNOPSIS
     Usage: set-log-notifier-configuration 
             --useseparatelogfile=true|false
             [--dynamic=false]
             [--target=server]
             --enabled=true|false 

OPTIONS
     --useseparatelogfile
     --dynamic
     --target
     --enabled
----

For example:
[source, shell]
----
asadmin> set-log-notifier-configuration --enabled=true --dynamic=true
----

To get the current configuration of the log notifier, run the following command:

[source, shell]
----
asadmin> get-log-notifier-configuration
----

[[jms-notifier]]
== JMS Notifier

The _Java Message Service (JMS)_ API is a messaging API which can be used
to enable asynchronous communication between clients. The Payara JMS
notifier makes use of a JMS queue to send notification events from
services such as the Request Tracing and HealthCheck services. These can
then be consumed by a custom MDB or other JMS compatible client.

[[requirements-1]]
=== Requirements

To use JMS as a notification target, you will need the following:

. *A JMS broker*
. *Payara Server Full Profile*

IMPORTANT: Payara Server Web Profile does not come with native
JMS capabilities, so this notifier isn't supported in it.

NOTE: The easiest way to configure the JMS notifier is to use the
embedded OpenMQ broker, since Payara Server Community ships with embedded OpenMQ by default.

[[configuration-1]]
=== JMS Notifier Configuration

Configuration requires the following few steps:

. Create a new *JMS Queue* to receive the notification messages from the notifier:
+
image:notification-service/jms/prepare-jms-destination.png[Create JMS Queue]
+
To make this change via the asadmin tool, use the following command
which mirrors the above screenshot:
+
[source, shell]
----
asadmin create-jms-resource --enabled=true --property=Name=notifierQueue --restype=javax.jms.queue jms/notifierQueue
----

. Set the properties for the JMS Notifier:
+
image:notification-service/jms/admin-console-configuration.png[Configure JMS Notifier in Admin Console]
+
The above example uses the embedded OpenMQ broker default configuration.
+
To make this change via the asadmin tool, use the following command
which mirrors the above screenshot:
+
[source, shell]
----
asadmin set-jms-notifier-configuration --dynamic=true --enabled=true --contextFactoryClass=com.sun.enterprise.naming.SerialInitContextFactory --target=server-config --queueName=notifierQueue --url=localhost:7676 --connectionFactoryName=jms/_defaultConnectionFactory
----

[[verify-the-configuration]]
=== Verifying the Configuration

For verification purposes, it may be useful to enable a service to push notifications through the JMS
notifier to demonstrate that it is working. To do this, we will also
need a Message-Driven Bean (MDB) to consume the notifications and
demonstrate that they are being received on the queue.

. First, enable a service to push data through the notifier. For
example, the HealthCheck service's CPU metric can be configured to push
CPU metrics to a notifier every _5 seconds_:
+
[source, shell]
----
asadmin> healthcheck-configure --enabled=true --dynamic=true --enableNotifiers=jms-notifier
asadmin> healthcheck-configure-service --serviceName=healthcheck-cpu --enabled=true --dynamic=true --time=5 --unit=SECONDS
----
+
This also configures the healthcheck service to send notifications to the JMS notifier, so these messages will
begin to be sent to the configured queue right away.

. To consume the messages using a **JMS 2.0** compliant MDB, the following
class will work for a pre-configured queue named `notifierQueue`:
+
[source, java]
----
@MessageDriven(activationConfig = {
    @ActivationConfigProperty(propertyName = "destinationLookup", propertyValue = "jms/notifierQueue"),
    @ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Queue"),
    @ActivationConfigProperty(propertyName = "destination", propertyValue = "notifierQueue"),
})
public class NotificationConsumer implements MessageListener {

    @Override
    public void onMessage(Message message) {
        try {
            System.out.println("Message received: " + message.getBody(String.class));
        }
        catch (JMSException ex) {}
    }
}
----

. View the result of the MessageDrivenBean's `onMessage()` command. In
this example, the CPU metric of the health check service was configured
to notify every _5 seconds_, so the result of simply printing to `System.out` is following log entries:
+
[source, shell]
----
[2017-02-24T14:25:02.019+0000] [Payara 4.1] [INFO] [] [fish.payara.nucleus.healthcheck.HealthCheckService] [tid: _ThreadID=151 _ThreadName=admin-thread-pool::admin-listener(9)] [timeMillis: 1487946302019] [levelValue: 800] [[
  Scheduling Health Check for task: CPUC]]

[2017-02-24T14:25:02.019+0000] [Payara 4.1] [INFO] [] [fish.payara.nucleus.healthcheck.HealthCheckService] [tid: _ThreadID=151 _ThreadName=admin-thread-pool::admin-listener(9)] [timeMillis: 1487946302019] [levelValue: 800] [[
  Payara Health Check Service Started.]]

[2017-02-24T14:25:02.376+0000] [Payara 4.1] [INFO] [] [] [tid: _ThreadID=48 _ThreadName=p: thread-pool-1; w: 3] [timeMillis: 1487946302376] [levelValue: 800] [[
  Message received: Health Check notification with severity level: INFO. (host:mike-payara, server:server, domain:domain1,instance:server)
CPUC:Health Check Result:[[status=GOOD, message='CPU%: 1.45, Time CPU used: 3 seconds 797 milliseconds'']']]]

[2017-02-24T14:25:02.380+0000] [Payara 4.1] [INFO] [] [] [tid: _ThreadID=50 _ThreadName=p: thread-pool-1; w: 5] [timeMillis: 1487946302380] [levelValue: 800] [[
  Message received: Health Check notification with severity level: SEVERE. (host:mike-payara, server:server, domain:domain1,instance:server)
CPUC:Health Check Result:[[status=CRITICAL, message='CPU%: 109.71, Time CPU used: 7 milliseconds'']']]]
----

[[asadmin-commands]]
=== Asadmin Commands

[[set-the-jms-notifier-configuration]]
==== Set the JMS notifier configuration

To set the JMS notifier configuration, the following asadmin command
will reflect the configuration done in the previous section:


[source, shell]
----
asadmin> set-jms-notifier-configuration --dynamic=true --enabled=true
  --contextFactoryClass=com.sun.enterprise.naming.SerialInitContextFactory
  --connectionFactoryName=jms/__defaultConnectionFactory
  --queueName=notifierQueue
  --url=localhost:7676
  --username= ****
  --password= ****
  --target=server-config
----

[[get-the-jms-notifier-configuration]]
==== Get the JMS notifier configuration

To get the current JMS notifier configuration using asadmin, run the following
command:

[source, shell]
----
asadmin> get-jms-notifier-configuration
----

It will return the details of the current JMS notifier configuation,
like in the following example:

----
Enabled  Noisy  Context Factory Class                               Connection Factory Name         Queue Name     URL             Username    Password
true     true   com.sun.enterprise.naming.SerialInitContextFactory  jms/__defaultConnectionFactory  notifierQueue  localhost:7676  myusername  mypassword
----

== Event Bus Notifier

The Event Bus Notifier provides a way to send notifications from the notification service into the internal Payara event bus based on Hazelcast distributed topics.

NOTE: Notifications sent to the internal Payara event bus using this notifier are intended to be received by internal Payara Server components and not by deployed applications. Currently, no built-in internal components consume event bus notifications yet and no API is exposed to consume them by the deployed applications.

[[requirements-2]]
=== Requirements

Hazelcast must be enabled for the Event Bus to be available.

[[notifier-configuration-1]]
=== Event Bus Notifier Configuration

This notifier provides only one configuration option - **Topic Name** - which is mandatory.

In the Admin Console, simply set Topic Name to an arbitrary name. This Hazelcast topic will receive the notifications.

image:notification-service/event-bus/event-bus-notif-config.png[Admin console config]

Make sure that the "Enabled" box is ticked so that the notifier will be used. If you would like the changes to take effect without needing a restart, tick the "Dynamic" box as well.

To make these changes via the asadmin tool, use the following command, which mirrors the above screenshot:

[source, shell]
----
asadmin> set-eventbus-notifier-configuration --topicName=my-topic --dynamic=true --enabled=true
----

To check the current applied configuration from asadmin, run the command:

[source, shell]
----
asadmin> get-eventbus-notifier-configuration
----

This will return the current configuration, with whether it is currently enabled and the name of the destination topic:

[source, shell]
----
$ asadmin get-eventbus-notifier-configuration
Enabled  Noisy  Topic Name
false    true   payara.notification.event
----

== CDI Event Bus Notifier

The CDI Event Bus Notifier provides a way to send notifications from the notification service into the internal Payara event bus.

[[notifier-configuration-2]]
=== CDI Event Bus Notifier Configuration

image:notification-service/cdi-event-bus/cdi-event-bus-notif-config.png[Admin console config]

`Enabled`::
Enables/Disables the CDI Event Bus notifier.
`Dynamic`::
Applies changes to the notifier without a server restart.
`Loop Back`::
Enables/Disables whether messages should also fire on the same instance or not

Make sure that the "Enabled" box is ticked so that the notifier will be used. If you would like the changes to take effect without needing a restart, tick the "Dynamic" box as well. If you want to receive the message events on the same instance, tick the "Loop Back" box as well. Otherwise, messages will be received only by remote Payara instances.

To make these changes via the asadmin tool, use the following command, which mirrors the above screenshot:

[source, shell]
----
asadmin> set-cdieventbus-notifier-configuration --loopBack=true --dynamic=true --enabled=true --hazelcastEnabled=true
----

To check the current applied configuration from asadmin, run the command:

[source, shell]
----
asadmin> get-cdieventbus-notifier-configuration
----

This will return the current configuration, with whether it is currently enabled and if looping back is enabled:

[source, shell]
----
$ asadmin get-cdieventbus-notifier-configuration
Enabled  Noisy  Loopback
false    true   false    
----

[[observing-events]]
=== Observing Notification Events

Any application deployed to any instance in the same cluster can observe notification events triggered by the CDI event bus notifier.

It would receive an instance of `EventbusMessage` (which extends `Notification`) that provides structured data about specific event type, such as `HealthCheckNotificationData` or `RequestTracingNotificationData`. It also provides the same information in a String form in the `title` and `message` fields.

In order to observe the events in an application, use the xref:/Technical Documentation/Public API/Overview.adoc[Payara API artifact] as a compile time dependency. 

Notification events can be observed as a standard `@Inbound` CDI event of type `EventbusMessage` or its supertypes:

[source, java]
----
    public void observe(@Observes @Inbound EventbusMessage event) {
        String shortInfo = event.getSubject()
        String detailedMessage = event.getMessage();
        
        String domainName = event.getDomain();
        String sourceInstanceName = event.getInstance();

        if (event.getData() instanceof HealthCheckNotificationData) {
            Optional<HealthCheckResultEntry> mostCritical = event.getData()
            .as(HealthCheckNotificationData.class).getEntries()
            .stream().sorted().findFirst();
        }
    }
   
----

IMPORTANT: Observer methods must be methods of a CDI bean to receive the events.

[[notification-service-command-reference]]
== Notification Service Configuration Commands

Asadmin commands used to configure the notification service.

[[notification-configure]]
=== `notification-configure`

*Usage*::
`asadmin> notification-configure --enabled=true --dynamic=true`

*Aim*::
Enables or disables the service.

[[command-options]]
==== Command Options

[cols=",,,,",options="header",]
|=======================================================================
|Option |Type |Description |Default |Mandatory
|`--enabled=true` |Boolean |Enables or disables the service |False |No
|`--dynamic=true` |Boolean |When set to true, applies the changes
without a restart. Otherwise a restart is required. |False |No
|=======================================================================

NOTE: The argument `--dynamic=true` is necessary to turn on the service for a
running server, otherwise the change would only be applied after a
server restart.

[[example]]
==== Example

[source, shell]
----
asadmin> notification-configure --enabled=true --dynamic=true
----

[[list-notifiers]]
=== `list-notifiers`

*Usage*::
`asadmin> list-notifiers`

*Aim*::
Lists available notifiers to use with the service. These can then
be configured individually or referenced by other service commands, for
example the
xref:/documentation/payara-server/request-tracing-service/asadmin-commands.adoc[`Request Tracing Configuration`]
commands.

[[command-options-1]]
==== Command Options

There are no available options for this command.

[[example-1]]
==== Example

Running the command on release _4.1.1.164_ would yield the following results:

----
Available Notifier Services:
    service-log

Command list-notifiers executed successfully.
----

[[get-notification-configuration]]
=== `get-notification-configuration`

*Usage*::
`asadmin> get-notification-configuration`

*Aim*::
This command can be used to list the details of the Notification Service.

[[command-options-3]]
==== Command Options

There are no available options for this command.

[[example-3]]
==== Example

Running the command will give output similar to the following:

----
Enabled  Notifier Enabled  Notifier Name
false    false             service-log

Command get-notification-configuration executed successfully.
----

[[set-notification-configuration]]
=== `set-notification-configuration`

*Usage*::
`asadmin> set-notification-configuration --enabled=true --dynamic=true --notifierEnabled=true --notifierDynamic=true --useseparatelogfile=true`

*Aim*::
This command can be used to set the the configuration of the Notification Service and the Log Notifier
at the same time.

[[command-options-4]]
==== Command Options

[cols=",,,,",options="header",]
|=======================================================================
|Option |Type |Description |Default |Mandatory
|`--enabled=true` |Boolean |Enables or disables the service |False |No
|`--dynamic=true` |Boolean |When set to true, applies the changes
without a restart. Otherwise a restart is required. |False |No
|`--notifierEnabled` |Boolean |Enables or disables the log notifier |false
|Yes
|`--notifierDynamic` |Boolean |When set to true, applies the
changes to the log notifier without a restart. Otherwise a restart is required. |false |No
|`--useseparatelogfile` |Boolean |When set to true, prints notifications to the configured
 log file |false |No
|=======================================================================

[[example-4]]
==== Example

[source, shell]
----
asadmin> set-notification-configuration
    --enabled=true
    --dynamic=true
    --notifierEnabled=true
    --notifierDynamic=true
    --useseparatelogfile=false
----
